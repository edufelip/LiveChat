name: iOS Release

on:
  push:
    branches:
      - "main"
      - "release/**"
      - "hotfix/**"
  workflow_dispatch:
    inputs:
      export_method:
        description: "Export method (app-store, ad-hoc, enterprise)"
        required: false
        default: "app-store"

concurrency:
  group: ios-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Archive & Upload to TestFlight
    runs-on: macos-26
    timeout-minutes: 150
    env:
      BUNDLE_ID: com.edufelip.livechat
      KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
      EXPORT_METHOD: ${{ github.event.inputs.export_method || 'app-store' }}
      GRADLE_OPTS: -Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g
      ORG_GRADLE_PROJECT_org.gradle.workers.max: "2"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Xcode & SDK versions
        run: |
          xcode-select -p
          xcodebuild -version
          xcodebuild -showsdks

      - name: Capture Xcode version
        run: |
          echo "XCODE_VERSION=$(xcodebuild -version | head -n 1 | awk '{print $2}')" >> "$GITHUB_ENV"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Cache Kotlin/Native
        uses: actions/cache@v4
        with:
          path: |
            ~/.konan
            ~/.kotlin
          key: ${{ runner.os }}-konan-${{ env.XCODE_VERSION }}-${{ hashFiles('**/*.gradle*', '**/*.kts', 'gradle/libs.versions.toml', 'gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - name: Write GoogleService-Info.plist
        env:
          IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64: ${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64 }}
        run: |
          mkdir -p iosApp/iosApp
          echo "$IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > iosApp/iosApp/GoogleService-Info-Prod.plist

      - name: Preflight iOS scheme + Firebase config
        run: |
          if [[ "$BUNDLE_ID" == *.dev ]]; then
            echo "BUNDLE_ID is set to a dev bundle id: $BUNDLE_ID"
            exit 1
          fi

          if [ ! -f "iosApp/iosApp/GoogleService-Info-Prod.plist" ]; then
            echo "Missing iosApp/iosApp/GoogleService-Info-Prod.plist"
            exit 1
          fi

          export SCHEMES_LIST
          SCHEMES_LIST=$(xcodebuild -workspace iosApp/iosApp.xcworkspace -list)
          echo "$SCHEMES_LIST"
          python - <<'PY'
          import os, sys

          scheme_lines = [line.strip() for line in os.environ["SCHEMES_LIST"].splitlines()]
          if "iosApp" not in scheme_lines:
              print("Scheme iosApp not found in workspace.")
              sys.exit(1)
          PY

      - name: Set up keychain and certificates
        env:
          CERT_P12_BASE64: ${{ secrets.IOS_DIST_CERT_P12_BASE64 }}
          CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
          PROFILE_BASE64: ${{ secrets.IOS_PROFILE_BASE64 }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/live-chat.keychain-db"
          CERTIFICATE_PATH="$RUNNER_TEMP/distribution_certificate.p12"
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"

          echo -n "$CERT_P12_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"
          echo -n "$PROFILE_BASE64" | base64 --decode -o "$PROFILE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERTIFICATE_PATH" \
            -P "$CERT_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          PROFILE_PLIST="$RUNNER_TEMP/profile.plist"
          security cms -D -i "$PROFILE_PATH" > "$PROFILE_PLIST"

          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print:UUID' "$PROFILE_PLIST" 2>/dev/null || true)
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print:Name' "$PROFILE_PLIST" 2>/dev/null || true)
          PROFILE_APP_ID=$(/usr/libexec/PlistBuddy -c 'Print:Entitlements:application-identifier' "$PROFILE_PLIST" 2>/dev/null || true)

          if [ -z "$PROFILE_UUID" ] || [ -z "$PROFILE_NAME" ] || [ -z "$PROFILE_APP_ID" ]; then
            echo "Failed to read provisioning profile metadata (UUID/Name/AppId)."
            ls -l "$PROFILE_PATH" "$PROFILE_PLIST" || true
            head -n 40 "$PROFILE_PLIST" || true
            exit 1
          fi

          EXPECTED_APP_ID="${{ secrets.IOS_TEAM_ID }}.${BUNDLE_ID}"
          if [ "$PROFILE_APP_ID" != "$EXPECTED_APP_ID" ]; then
            echo "Provisioning profile app id mismatch."
            echo "  Expected: $EXPECTED_APP_ID"
            echo "  Found   : $PROFILE_APP_ID"
            exit 1
          fi

          if ! security find-identity -p codesigning -v "$KEYCHAIN_PATH" | grep -q "Apple Distribution"; then
            echo "No Apple Distribution signing identity found in keychain $KEYCHAIN_PATH"
            security find-identity -p codesigning -v "$KEYCHAIN_PATH" || true
            exit 1
          fi
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/${PROFILE_UUID}.mobileprovision"
          echo "PROFILE_UUID=$PROFILE_UUID" >> "$GITHUB_ENV"
          echo "PROFILE_NAME=$PROFILE_NAME" >> "$GITHUB_ENV"

      - name: Build Compose frameworks (Release/iphoneos)
        run: ./gradlew -Dorg.gradle.jvmargs="-Xmx8g -XX:MaxMetaspaceSize=1g -Dfile.encoding=UTF-8" :app:iosArm64AggregateResources :app:assembleLiveChatComposeReleaseXCFramework --stacktrace --build-cache

      - name: Verify Compose resources present
        run: |
          RESOURCE_DIR="app/build/kotlin-multiplatform-resources/aggregated-resources/iosArm64/composeResources"
          if [ ! -d "$RESOURCE_DIR" ]; then
            echo "Compose resources missing at $RESOURCE_DIR"
            exit 1
          fi

      - name: Bump iOS build number
        run: /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $GITHUB_RUN_NUMBER" iosApp/iosApp/Info.plist

      - name: Build archive
        env:
          KEYCHAIN_PATH: ${{ runner.temp }}/live-chat.keychain-db
          IOS_PROFILE_NAME: ${{ env.PROFILE_NAME }}
        run: |
          xcodebuild \
            -workspace iosApp/iosApp.xcworkspace \
            -scheme "iosApp" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath iosApp/build/iosApp.xcarchive \
            -destination "generic/platform=iOS" \
            DEVELOPMENT_TEAM="${{ secrets.IOS_TEAM_ID }}" \
            PRODUCT_BUNDLE_IDENTIFIER="${BUNDLE_ID}" \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            archive

      - name: Export IPA
        env:
          KEYCHAIN_PATH: ${{ runner.temp }}/live-chat.keychain-db
        run: |
          cat <<EOF > iosApp/ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>method</key><string>${EXPORT_METHOD}</string>
              <key>signingStyle</key><string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                <key>${BUNDLE_ID}</key><string>${PROFILE_NAME:-${{ secrets.IOS_PROFILE_NAME }}}</string>
              </dict>
              <key>stripSwiftSymbols</key><true/>
              <key>compileBitcode</key><false/>
            </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath iosApp/build/iosApp.xcarchive \
            -exportOptionsPlist iosApp/ExportOptions.plist \
            -exportPath iosApp/build/export \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH"

      - name: Upload IPA to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          mkdir -p "$HOME/.private_keys"
          KEY_FILE="$HOME/.private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8"
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" | base64 --decode > "$KEY_FILE"

          IPA_PATH=$(ls iosApp/build/export/*.ipa | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "IPA not found after export" && exit 1
          fi

          xcrun altool --upload-app -f "$IPA_PATH" -t ios \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_KEY_ISSUER_ID"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: iosApp.ipa
          path: iosApp/build/export/*.ipa

      - name: Clean keychain and profiles
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/live-chat.keychain-db"
          security delete-keychain "$KEYCHAIN_PATH" || true
          rm -f "$HOME/Library/MobileDevice/Provisioning Profiles/"*.mobileprovision || true
